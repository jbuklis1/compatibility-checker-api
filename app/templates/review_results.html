<h1>Results: {file_path}</h1>
{error_block}
<script type="application/json" id="results-data">{results_json}</script>
<script>
(function() {{
  const dataEl = document.getElementById('results-data');
  if (dataEl) {{
    try {{
      const results = JSON.parse(dataEl.textContent);
      const cacheKey = 'compat_checker_results_' + results.file_path;
      localStorage.setItem(cacheKey, JSON.stringify(results));
    }} catch (e) {{
      console.error('Failed to cache results:', e);
    }}
  }}
}})();
</script>
<p><strong>{issue_count}</strong> issue(s) found ({error_count} error(s), {warning_count} warning(s), {info_count} info).</p>
{issues_block}
{suggestions_block}
{tests_block}
<div class="download-section">
  <button onclick="downloadReport()" class="download-button">⬇ Download Report</button>
  <a href="/review" class="action-button">Analyze another file</a>
  <a href="/" class="action-button">Home</a>
</div>
<p class="results-nav-links"><a href="/docs">Swagger UI</a></p>
<script>
function downloadReport() {{
  const dataEl = document.getElementById('results-data');
  if (!dataEl) {{
    alert('Results data not found');
    return;
  }}
  try {{
    const results = JSON.parse(dataEl.textContent);
    const report = formatTextReport(results);
    const blob = new Blob([report], {{ type: 'text/markdown' }});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const base = (results.file_name || 'report').replace(/\.[^/.]+$/, '') || results.file_name || 'report';
    const safe = base.replace(/[^\\w\\-]/g, '_').replace(/^_+|_+$/g, '').slice(0, 80) || 'compatibility_report';
    a.download = safe + '_compatibility_report.md';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }} catch (e) {{
    console.error('Download failed:', e);
    alert('Download failed. Please try again.');
  }}
}}

function formatTextReport(results) {{
  function titleCase(s) {{
    if (!s) return s;
    return s.replace(/_/g, ' ').trim().toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase());
  }}
  function normalizeEscapes(text) {{
    if (!text) return text;
    return text.replace(/\\r\\n/g, '\\n').replace(/\\n/g, '\\n').replace(/\\t/g, '\\t');
  }}

  const lines = [];
  lines.push('# Results: ' + results.file_path);
  lines.push('');
  lines.push('Generated: ' + new Date().toLocaleString());
  lines.push('');

  const errors = results.issues.filter(i => i.severity === 'ERROR');
  const warnings = results.issues.filter(i => i.severity === 'WARNING');
  const infos = results.issues.filter(i => i.severity === 'INFO');
  lines.push('**' + results.issues.length + '** issue(s) found (' + errors.length + ' error(s), ' + warnings.length + ' warning(s), ' + infos.length + ' info).');
  lines.push('');
  lines.push('## Issues');
  lines.push('');

  if (results.issues.length === 0) {{
    lines.push('No compatibility issues found.');
    lines.push('');
  }} else {{
    [].concat(errors, warnings, infos).forEach(i => {{
      const cat = titleCase(i.category || '');
      const sev = titleCase(i.severity || '');
      lines.push('**Line ' + i.line_number + ' · ' + cat + ' · ' + sev + '**');
      lines.push('');
      lines.push(i.message);
      lines.push('');
      lines.push('- **Code:**');
      lines.push('```');
      lines.push(i.code);
      lines.push('```');
      lines.push('');
      lines.push('- **Fix:**');
      lines.push('```');
      lines.push(i.suggestion);
      lines.push('```');
      lines.push('');
    }});
  }}

  if (results.ai_suggestions) {{
    lines.push('## AI fix suggestions');
    lines.push('');
    lines.push(normalizeEscapes(results.ai_suggestions).trim());
    lines.push('');
  }}
  if (results.generated_tests) {{
    lines.push('## Generated tests');
    lines.push('');
    lines.push(normalizeEscapes(results.generated_tests).trim());
    lines.push('');
  }}

  return lines.join('\n');
}}
</script>
